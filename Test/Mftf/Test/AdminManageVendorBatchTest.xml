<?xml version="1.0" encoding="UTF-8"?>
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="../../../../../../vendor/magento/magento2-functional-testing-framework/src/Magento/FunctionalTestingFramework/Test/etc/testSchema.xsd">
    <test name="AdminManageVendorBatchExport">
        <annotations>
            <features value="Manage Vendor Batch Export"/>
            <stories value="Manage Vendor Batch Exoport"/>
            <title value="Export Vendor Batch"/>
            <description value="Export Vendor Batch "/>
            <group value="iredeem"/>
            <group value="vendorBatch"/>
        </annotations>
        <before>
            <actionGroup ref="LoginAsAdmin" stepKey="loginAsAdminForVendor1"/>
        </before>
        <after>
            <amOnPage url="admin/admin/auth/logout/" stepKey="amOnLogoutPage"/>
        </after>

        <actionGroup ref="CreateVendor" stepKey="createVendor"/>

        <!--#### Create Export Batch ####-->
        <!-- Filter saved vendor so we can get the id -->
        <click selector="{{AdminVendorGridSection.filters}}" stepKey="clickOnFilters"/>
        <fillField selector="{{AdminVendorGridSection.VendorName}}" userInput="{{VendorData.name}}" stepKey="filterVendorName"/>
        <fillField selector="{{AdminVendorGridSection.VendorEmail}}" userInput="{{VendorData.email}}" stepKey="filterVendorEmail"/>
        <fillField selector="{{AdminVendorGridSection.VendorTelephone}}" userInput="{{VendorData.telephone}}" stepKey="filterVendorPhone"/>
        <click selector="{{AdminVendorGridSection.applyFilters}}" stepKey="clickApplyFiltersButton"/>
        <waitForAjaxLoad stepKey="waitForResults"/>

        <!-- Get the vendor id -->
        <grabTextFrom selector="{{AdminVendorGridSection.firstRowIdColumn}}" stepKey="grabVendorId"/>

        <amOnPage url="{{VendorPageData.createExportBatchUrl}}" stepKey="amOnCreateBatchVendorsPageEdit"/>
        <waitForPageLoad stepKey="waitCreateBatchExportPageLoad"/>
        <selectOption selector="{{AdminExportBatchPage.vendor}}" userInput="{$grabVendorId}" stepKey="selectVendorForExport"/>
        <click selector="{{AdminExportBatchPage.saveButton}}" stepKey="clickSaveExportBatchButton"/>
        <waitForPageLoad stepKey="waitSaveBatchExportPageLoad"/>

        <!--Filter by vendor and type-->
        <click selector="{{AdminExportBatchPage.filters}}" stepKey="clickOnExportBatchFilters"/>
        <selectOption selector="{{AdminExportBatchPage.batchVendorFilter}}" userInput="{$grabVendorId}" stepKey="selectVendorFilter"/>
        <selectOption selector="{{AdminExportBatchPage.batchTypeFilter}}" userInput="{{VendorPageData.batchTypeExport}}" stepKey="selectBatchTypeFilter"/>
        <selectOption selector="{{AdminExportBatchPage.batchStatusFilter}}" userInput="{{VendorPageData.batchStatusScheduled}}" stepKey="selectBatchStatusFilter"/>
        <click selector="{{AdminExportBatchPage.applyFilters}}" stepKey="clickOnExportBatchApplyFilters"/>
        <waitForAjaxLoad stepKey="waitForBatchFilterResults"/>

        <!-- Check export in grid -->
        <see selector="tr[data-repeat-index='0'] td:nth-child(3) .data-grid-cell-content" userInput="{{VendorData.name}}" stepKey="checkBatchVendorName"/>
        <see selector="tr[data-repeat-index='0'] td:nth-child(4) .data-grid-cell-content" userInput="Export" stepKey="checkBatchTypeExport"/>
        <see selector="tr[data-repeat-index='0'] td:nth-child(5) .data-grid-cell-content" userInput="Scheduled" stepKey="checkBatchStatusScheduled"/>

        <!-- Clear filters -->
        <click selector="{{AdminExportBatchPage.clearFilters}}" stepKey="clickClearFilters"/>
        <waitForAjaxLoad stepKey="waitForBatchFilterCleared"/>

        <!--Delete batch export-->
        <click selector="{{AdminExportBatchPage.filters}}" stepKey="clickOnBatchFilters"/>
        <selectOption selector="{{AdminExportBatchPage.batchVendorFilter}}" userInput="{$grabVendorId}" stepKey="selectVendor"/>
        <selectOption selector="{{AdminExportBatchPage.batchTypeFilter}}" userInput="{{VendorPageData.batchTypeExport}}" stepKey="selectBatchType"/>
        <selectOption selector="{{AdminExportBatchPage.batchStatusFilter}}" userInput="{{VendorPageData.batchStatusScheduled}}" stepKey="selectBatchStatus"/>
        <click selector="{{AdminExportBatchPage.applyFilters}}" stepKey="clickOnBatchApplyFilters"/>
        <waitForAjaxLoad stepKey="waitForFilterResults"/>

        <!--Select batch export-->
        <click selector="{{AdminExportBatchPage.selectOption}}" stepKey="clickOnSelect"/>
        <click selector="{{AdminExportBatchPage.selectAll}}" stepKey="clickSelectAll"/>

        <!--Delete batch-->
        <click selector="{{AdminExportBatchPage.actionsOption}}" stepKey="clickonActions"/>
        <click selector="{{AdminExportBatchPage.deleteBatch}}" stepKey="deleteBatch"/>
        <waitForPageLoad stepKey="waitForMessage"/>
        <see selector="{{AdminVendorMessagesSection.SuccessMessage}}" userInput="Batches deleted successfully." stepKey="assertDeletionSuccess"/>
    </test>

    <test name="AdminManageVendorBatchExportImport">
        <annotations>
            <features value="Manage Vendor Batch"/>
            <stories value="Manage Vendor Batch"/>
            <title value="Export Vendor Batch and Import it from a file"/>
            <description value="Export Vendor Batch and Import it from a file"/>
            <group value="iredeem"/>
            <group value="vendorBatchExportImport"/>
        </annotations>
        <before>
            <actionGroup ref="LoginAsAdmin" stepKey="loginAsAdminForVendor1"/>
        </before>
        <after>
            <amOnPage url="admin/admin/auth/logout/" stepKey="amOnLogoutPage"/>
        </after>

        <actionGroup ref="CreateVendor" stepKey="createVendor"/>

        <!--#### Create Export Batch ####-->
        <!-- Filter saved vendor so we can get the id -->
        <click selector="{{AdminVendorGridSection.filters}}" stepKey="clickOnFilters"/>
        <fillField selector="{{AdminVendorGridSection.VendorName}}" userInput="{{VendorData.name}}" stepKey="filterVendorName"/>
        <fillField selector="{{AdminVendorGridSection.VendorEmail}}" userInput="{{VendorData.email}}" stepKey="filterVendorEmail"/>
        <fillField selector="{{AdminVendorGridSection.VendorTelephone}}" userInput="{{VendorData.telephone}}" stepKey="filterVendorPhone"/>
        <click selector="{{AdminVendorGridSection.applyFilters}}" stepKey="clickApplyFiltersButton"/>
        <waitForAjaxLoad stepKey="waitForResults"/>

        <!-- Get the vendor id -->
        <grabTextFrom selector="{{AdminVendorGridSection.firstRowIdColumn}}" stepKey="grabVendorId"/>

        <amOnPage url="{{VendorPageData.createExportBatchUrl}}" stepKey="amOnCreateBatchVendorsPageEdit"/>
        <waitForPageLoad stepKey="waitCreateBatchExportPageLoad"/>
        <selectOption selector="{{AdminExportBatchPage.vendor}}" userInput="{$grabVendorId}" stepKey="selectVendorForExport"/>
        <click selector="{{AdminExportBatchPage.saveButton}}" stepKey="clickSaveExportBatchButton"/>
        <waitForPageLoad stepKey="waitSaveBatchExportPageLoad"/>

        <!--Filter by vendor and type-->
        <click selector="{{AdminExportBatchPage.filters}}" stepKey="clickOnExportBatchFilters"/>
        <selectOption selector="{{AdminExportBatchPage.batchVendorFilter}}" userInput="{$grabVendorId}" stepKey="selectVendorFilter"/>
        <selectOption selector="{{AdminExportBatchPage.batchTypeFilter}}" userInput="{{VendorPageData.batchTypeExport}}" stepKey="selectBatchTypeFilter"/>
        <selectOption selector="{{AdminExportBatchPage.batchStatusFilter}}" userInput="{{VendorPageData.batchStatusScheduled}}" stepKey="selectBatchStatusFilter"/>
        <click selector="{{AdminExportBatchPage.applyFilters}}" stepKey="clickOnExportBatchApplyFilters"/>
        <waitForAjaxLoad stepKey="waitForBatchFilterResults"/>

        <!-- Check export in grid -->
        <see selector="tr[data-repeat-index='0'] td:nth-child(3) .data-grid-cell-content" userInput="{{VendorData.name}}" stepKey="checkBatchVendorName"/>
        <see selector="tr[data-repeat-index='0'] td:nth-child(4) .data-grid-cell-content" userInput="Export" stepKey="checkBatchTypeExport"/>
        <see selector="tr[data-repeat-index='0'] td:nth-child(5) .data-grid-cell-content" userInput="Scheduled" stepKey="checkBatchStatusScheduled"/>

        <!-- Clear filters -->
        <click selector="{{AdminExportBatchPage.clearFilters}}" stepKey="clickClearFilters"/>
        <waitForAjaxLoad stepKey="waitForBatchFilterCleared"/>

        <!--####Create Import Batch####-->
        <amOnPage url="{{VendorPageData.createImportBatchUrl}}" stepKey="amOnBatchCreateImportPage"/>
        <waitForPageLoad stepKey="waitForImportPageLoad"/>

        <!--Fill required fields and add import file-->
        <selectOption selector="{{BatchSection.SelectVendor}}" userInput="{{VendorData.name}}" stepKey="selectVendorBatch"/>
        <click selector="{{BatchSection.VendorDefaultLocation}}" stepKey="clickDefaultLocation"/>
        <attachFile selector="{{BatchSection.File}}" userInput="{{BatchImport.fileData}}" stepKey="selectFile"/>

        <!--Save import and check message-->
        <click selector="{{BatchSection.SaveImport}}" stepKey="clickSaveButton"/>
        <waitForPageLoad stepKey="waitForPageLoad"/>
        <seeElement selector="{{AdminVendorMessagesSection.SuccessMessage}}" stepKey="assertCreationSuccess"/>

        <!--Delete batch export and import-->
        <click selector="{{AdminExportBatchPage.filters}}" stepKey="clickOnBatchFilters"/>
        <selectOption selector="{{AdminExportBatchPage.batchVendorFilter}}" userInput="{$grabVendorId}" stepKey="selectVendor"/>
        <click selector="{{AdminExportBatchPage.applyFilters}}" stepKey="clickOnBatchApplyFilters"/>
        <waitForAjaxLoad stepKey="waitForFilterResults"/>

        <!--Select batch export and import-->
        <click selector="{{AdminExportBatchPage.selectOption}}" stepKey="clickOnSelect"/>
        <click selector="{{AdminExportBatchPage.selectAll}}" stepKey="clickSelectAll"/>

        <!--Delete batch export and import-->
        <click selector="{{AdminExportBatchPage.actionsOption}}" stepKey="clickonActions"/>
        <click selector="{{AdminExportBatchPage.deleteBatch}}" stepKey="deleteBatch"/>
        <waitForPageLoad stepKey="waitForMessage"/>
        <see selector="{{AdminVendorMessagesSection.SuccessMessage}}" userInput="Batches deleted successfully." stepKey="assertDeletionSuccess"/>
    </test>
</tests>
